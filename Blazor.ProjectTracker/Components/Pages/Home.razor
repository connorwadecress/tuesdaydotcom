@page "/"
@rendermode InteractiveServer
@using Blazor.ProjectTracker.Components.SharedComponents
@using global::ProjectTracker.Application.Services
@using global::ProjectTracker.Domain.Entities
@using global::ProjectTracker.Application.Interfaces
@inject NavigationManager Navigation
@inject IProjectService ProjectService;


<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6">
    <!-- Header -->
    <MudGrid Class="mb-4" AlignItems="Center">
        <MudItem xs="12" sm="6">
            <MudText Typo="Typo.h4">My Projects</MudText>
        </MudItem>
        <MudItem xs="12" sm="6" Class="d-flex justify-end">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddProject" StartIcon="@Icons.Material.Filled.Add">
                Add Project
            </MudButton>
        </MudItem>
    </MudGrid>
@* 
    <MudPaper Elevation="1" Class="p-4 mb-4">
        <MudGrid Spacing="2">
            <!-- Filter: Name -->
            <MudItem xs="12" sm="6" md="3">
                <MudTextField T="string"
                              @bind-Value="NameFilter"
                              @bind-Value:event="oninput"
                              Label="Search by name"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense" />

            </MudItem>

            <!-- Filter: Status -->
            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="string"
                           @bind-Value="StatusFilter"
                           Label="Status"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Margin="Margin.Dense">
                    <MudSelectItem Value="@("")">All</MudSelectItem>
                    @foreach (var status in StatusOptions)
                    {
                        <MudSelectItem Value="@status">@status</MudSelectItem>
                    }
                </MudSelect>

            </MudItem>

            <!-- Filter: Tag -->
            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="string"
                           @bind-Value="TagFilter"
                           Label="Tag"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Margin="Margin.Dense">
                    <MudSelectItem Value="@("")">All</MudSelectItem>
                    @foreach (var tag in TagOptions)
                    {
                        <MudSelectItem Value="@tag">@tag</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <!-- Filter: Date -->
            <MudItem xs="12" sm="6" md="3">
                <MudDatePicker @bind-Date="DateFilter"
                               Label="Created On"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               Clearable="true"
                               DateFormat="yyyy-MM-dd"/>
            </MudItem>

            <!-- Clear & Count -->
            <MudItem xs="12" Class="d-flex justify-between align-items-center mt-2">
                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Clear"
                           OnClick="ClearFilters">
                    Clear Filters
                </MudButton>
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Showing <strong>@FilteredProjects.Count()</strong> / @Projects.Count project(s)
                </MudText>
            </MudItem>
        </MudGrid>
    </MudPaper> *@


    <!-- Project Cards -->
    @if (FilteredProjects.Any())
    {
        @foreach (var project in FilteredProjects)
        {
            <RowComponent Title="@project.Name"
                          Tags="@project.Tags.ToList()"
                          Status="@project.Status"
                          Date="@project.DateCreated"
                          OnClick="() => OnRowClicked(project)" />
        }
    }
    else
    {
        <MudText Typo="Typo.subtitle1" Color="Color.Secondary">No projects match the selected filters.</MudText>
    }
</MudContainer>

@code {
    private List<Project> Projects = new();

    // Filters
    private string? _nameFilter;
    private string? NameFilter
    {
        get => _nameFilter;
        set
        {
            _nameFilter = value;
            StateHasChanged();
        }
    }

    private string? _statusFilter;
    private string? StatusFilter
    {
        get => _statusFilter;
        set
        {
            _statusFilter = value;
            StateHasChanged();
        }
    }

    private string? _tagFilter;
    private string? TagFilter
    {
        get => _tagFilter;
        set
        {
            _tagFilter = value;
            StateHasChanged();
        }
    }

    private DateTime? _dateFilter;
    private DateTime? DateFilter
    {
        get => _dateFilter;
        set
        {
            _dateFilter = value;
            StateHasChanged();
        }
    }


    // Filtered results
    private IEnumerable<Project> FilteredProjects => Projects
        .Where(p => string.IsNullOrWhiteSpace(NameFilter) || p.Name.Contains(NameFilter, StringComparison.OrdinalIgnoreCase))
        .Where(p => string.IsNullOrWhiteSpace(StatusFilter) || p.Status == StatusFilter)
        .Where(p => string.IsNullOrWhiteSpace(TagFilter) || p.Tags.Any(t => t.Name == TagFilter))
        .Where(p => !DateFilter.HasValue || p.DateCreated.Date == DateFilter.Value.Date);

    // Dropdown options
    private IEnumerable<string> StatusOptions => Projects
        .Select(p => p.Status)
        .Where(s => !string.IsNullOrWhiteSpace(s))
        .Distinct()
        .OrderBy(s => s);

    private IEnumerable<string> TagOptions => Projects
        .SelectMany(p => p.Tags)
        .Where(t => !string.IsNullOrWhiteSpace(t.Name))
        .Select(t => t.Name)
        .Distinct()
        .OrderBy(t => t);

    protected override async Task OnInitializedAsync()
    {
        var projectsList = await ProjectService.GetAllAsync(default);
        Projects = projectsList.ToList();
    }

    private void ClearFilters()
    {
        NameFilter = null;
        StatusFilter = null;
        TagFilter = null;
        DateFilter = null;
    }

    private void OnRowClicked(Project p) => Navigation.NavigateTo($"/project/{p.Id}");
    private void AddProject() { Navigation.NavigateTo("/create-project"); }
}
